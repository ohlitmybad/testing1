<!DOCTYPE html>
<html>
<head>	

    <meta name="viewport" content="user-scalable=no">
	<meta name="robots" content="noindex">
  <link rel="stylesheet" href="styles.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
<script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>


<defs>
<style>

</style>



<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.9/xlsx.full.min.js"></script>

	
</head>

<body>
  <!-- Season selector aligned with navbar -->


  <div class="container">
    <div class="inputs-wrapper">
      <div class="inputs">
        <form id="searchForm">
          <!-- Custom position selector -->
          <div class="custom-select-container">
            <div class="custom-select-trigger" id="position-select-trigger">
              <span>Goalkeepers</span>
            </div>
            <div class="custom-select-options" id="position-select-options">
              <!-- Options will be populated by JavaScript -->
            </div>
            <select id="datasetSelector" style="display: none;" data-i18n="selectors.dataset">
              <option value="dataset1">Goalkeepers</option>
              <option value="dataset2">Centre-backs</option>
              <option value="dataset3">Full-backs</option>
              <option value="dataset4">Midfielders</option>
              <option value="dataset5">Wingers</option>
              <option value="dataset6">Strikers</option>
            </select>
          </div>
          <select id="league" style="display: none;">
            <option value="All"></option>
            <option value="Top 7 Leagues"></option>
            <option value="Top 5 Leagues"></option>
            <option value="Premier League"></option>
            <option value="La Liga"></option>
            <option value="Bundesliga"></option>
            <option value="Serie A"></option> 
            <option value="Ligue 1"></option>
            <option value="Eredivisie"></option>
            <option value="Primeira Liga"></option>
            <option value="Belgium Pro League"></option>
            <option value="Scotland Premiership"></option>
            <option value="Austrian Bundesliga"></option>
            <option value="Swiss Super League"></option>
            <option value="Süper Lig"></option>
            <option value="Denmark Superliga"></option>
            <option value="Sweden Allsvenskan"></option>
            <option value="Norway Eliteserien"></option>
            <option value="Croatia HNL"></option>
            <option value="Serbia SuperLiga"></option>
            <option value="Czech Fortuna Liga"></option>
            <option value="Poland"></option>
            <option value="Ukraine"></option>
            <option value="Russia"></option>
            <option value="Greece"></option>
            <option value="Israel"></option>
            <option value="J1 League"></option>
            <option value="K League 1"></option>
            <option value="Saudi Pro League"></option>
            <option value="MLS"></option>
            <option value="LigaMX"></option>
            <option value="Brazil Serie A"></option>
            <option value="Argentina Primera"></option>
            <option value="Uruguay Primera"></option>
            <option value="Chile"></option>
            <option value="Colombia"></option>
            <option value="Ecuador"></option>
            <option value="Paraguay"></option>
            <option value="Championship"></option>
            <option value="Segunda Division"></option>
            <option value="Serie B"></option>
            <option value="Bundesliga 2"></option>
            <option value="Ligue 2"></option>    
            <option value="Non Top 7 Leagues"></option>
            <option value="South America"></option>
            <option value="Scandinavia"></option>
            <option value="Balkans"></option>
        </select>
          <!-- Custom league selector -->
          <div class="custom-select-container">
            <div class="custom-select-trigger" id="league-select-trigger">
                <iconify-icon icon="emojione:globe-showing-europe-africa" width="18" height="18"></iconify-icon>
                <span data-i18n="leagues.all">All Leagues</span>
            </div>  
            <div class="custom-select-options" id="league-select-options">
                <div class="custom-select-option selected" data-value="All">
                    <iconify-icon icon="emojione:globe-showing-europe-africa" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.all">All Leagues</span>
                </div>  
                <div class="custom-select-option" data-value="Top 7 Leagues">
                    <iconify-icon icon="emojione:flag-for-flag-european-union" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.top7">Top 7 Leagues</span>
                </div>
                <div class="custom-select-option" data-value="Top 5 Leagues">
                    <iconify-icon icon="emojione:flag-for-flag-european-union" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.top5">Top 5 Leagues</span>
                </div>
                <div class="custom-select-option" data-value="Premier League">
                    <iconify-icon icon="emojione:flag-for-united-kingdom" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.premier">Premier League</span>
                </div>
                <div class="custom-select-option" data-value="La Liga">
                    <iconify-icon icon="emojione:flag-for-spain" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.la">La Liga</span>
                </div>
                <div class="custom-select-option" data-value="Bundesliga">
                    <iconify-icon icon="emojione:flag-for-germany" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.bundesliga">Bundesliga</span>
                </div>
                <div class="custom-select-option" data-value="Serie A">
                    <iconify-icon icon="emojione:flag-for-italy" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.seriea">Serie A</span>
                </div>
                <div class="custom-select-option" data-value="Ligue 1">
                    <iconify-icon icon="emojione:flag-for-france" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.ligue1">Ligue 1</span>
                </div>
                <div class="custom-select-option" data-value="Eredivisie">
                    <iconify-icon icon="emojione:flag-for-netherlands" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.eredivisie">Eredivisie</span>
                </div>
                <div class="custom-select-option" data-value="Primeira Liga">
                    <iconify-icon icon="emojione:flag-for-portugal" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.primeiraliga">Primeira Liga</span>
                </div>
                <div class="custom-select-option" data-value="Belgium Pro League">
                    <iconify-icon icon="emojione:flag-for-belgium" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.belgium">Belgium</span>
                </div>
                <div class="custom-select-option" data-value="Scotland Premiership">
                    <div style="width: 18px; height: 18px; border-radius: 50%; overflow: hidden; margin-right: 8px; background-color: #005EB8; background-image: url('https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/1f3f4-e0067-e0062-e0073-e0063-e0074-e007f.svg'); background-size: 150% 150%; background-position: center;"></div>
                    <span data-i18n="leagues.scotland">Scotland</span>
                </div>
                <div class="custom-select-option" data-value="Austrian Bundesliga">
                    <iconify-icon icon="emojione:flag-for-austria" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.austria">Austria</span>
                </div>  
                <div class="custom-select-option" data-value="Swiss Super League">
                    <iconify-icon icon="emojione:flag-for-switzerland" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.switzerland">Switzerland</span>
                </div>
                <div class="custom-select-option" data-value="Süper Lig">
                    <iconify-icon icon="emojione:flag-for-turkey" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.turkey">Turkiye</span>
                </div>
                <div class="custom-select-option" data-value="Denmark Superliga">
                    <iconify-icon icon="emojione:flag-for-denmark" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.denmark">Denmark</span>
                </div>
                <div class="custom-select-option" data-value="Sweden Allsvenskan">
                    <iconify-icon icon="emojione:flag-for-sweden" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.sweden">Sweden</span>
                </div>
                <div class="custom-select-option" data-value="Norway Eliteserien">
                    <iconify-icon icon="emojione:flag-for-norway" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.norway">Norway</span>
                </div>
                <div class="custom-select-option" data-value="Croatia HNL">
                    <iconify-icon icon="emojione:flag-for-croatia" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.croatia">Croatia</span>
                </div>
                <div class="custom-select-option" data-value="Serbia SuperLiga">
                    <iconify-icon icon="emojione:flag-for-serbia" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.serbia">Serbia</span>
                </div>
                <div class="custom-select-option" data-value="Czech Fortuna Liga">
                    <iconify-icon icon="emojione:flag-for-czechia" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.czechrepublic">Czech Republic</span>
                </div>
                <div class="custom-select-option" data-value="Poland">
                    <iconify-icon icon="emojione:flag-for-poland" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.poland">Poland</span>
                </div>
                <div class="custom-select-option" data-value="Ukraine">
                    <iconify-icon icon="emojione:flag-for-ukraine" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.ukraine">Ukraine</span>
                </div>
                <div class="custom-select-option" data-value="Russia">
                    <iconify-icon icon="emojione:flag-for-russia" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.russia">Russia</span>
                </div>
                <div class="custom-select-option" data-value="Greece">
                    <iconify-icon icon="emojione:flag-for-greece" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.greece">Greece</span>
                </div>
                <div class="custom-select-option" data-value="Israel">
                    <iconify-icon icon="emojione:flag-for-israel" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.israel">Israel</span>
                </div>
                <div class="custom-select-option" data-value="J1 League">
                    <iconify-icon icon="emojione:flag-for-japan" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.japan">Japan</span>
                </div>
                <div class="custom-select-option" data-value="K League 1">
                    <iconify-icon icon="emojione:flag-for-south-korea" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.korea">Korea</span>
                </div>
                <div class="custom-select-option" data-value="Saudi Pro League">
                    <iconify-icon icon="emojione:flag-for-saudi-arabia" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.saudiarabia">Saudi Arabia</span>
                </div>
                <div class="custom-select-option" data-value="MLS">
                    <iconify-icon icon="emojione:flag-for-united-states" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.unitedstates">MLS</span>
                </div>
                <div class="custom-select-option" data-value="LigaMX">
                    <iconify-icon icon="emojione:flag-for-mexico" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.mexico">Mexico</span>
                </div>
                <div class="custom-select-option" data-value="Brazil Serie A">
                    <iconify-icon icon="emojione:flag-for-brazil" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.brazil">Brazil</span>
                </div>
                <div class="custom-select-option" data-value="Argentina Primera">
                    <iconify-icon icon="emojione:flag-for-argentina" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.argentina">Argentina</span>
                </div>
                <div class="custom-select-option" data-value="Uruguay Primera">
                    <iconify-icon icon="emojione:flag-for-uruguay" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.uruguay">Uruguay</span>
                </div>
                <div class="custom-select-option" data-value="Chile">
                    <iconify-icon icon="emojione:flag-for-chile" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.chile">Chile</span>
                </div>
                <div class="custom-select-option" data-value="Colombia">
                    <iconify-icon icon="emojione:flag-for-colombia" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.colombia">Colombia</span>
                </div>
                <div class="custom-select-option" data-value="Ecuador">
                    <iconify-icon icon="emojione:flag-for-ecuador" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.ecuador">Ecuador</span>
                </div>
                <div class="custom-select-option" data-value="Paraguay">
                    <iconify-icon icon="emojione:flag-for-paraguay" width="18" height="18"></iconify-icon>  
                    <span data-i18n="leagues.paraguay">Paraguay</span>   
                </div>
                <div class="custom-select-option" data-value="Championship">
                    <iconify-icon icon="emojione:flag-for-united-kingdom" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.championship">Championship</span>
                </div>  
                <div class="custom-select-option" data-value="Segunda Division">
                    <iconify-icon icon="emojione:flag-for-spain" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.spain">Spain Segunda</span>
                </div>
                <div class="custom-select-option" data-value="Serie B">
                    <iconify-icon icon="emojione:flag-for-italy" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.serieb">Serie B</span>
                </div>
                <div class="custom-select-option" data-value="Bundesliga 2">
                    <iconify-icon icon="emojione:flag-for-germany" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.bundesliga2">2. Bundesliga</span>
                </div>
                <div class="custom-select-option" data-value="Ligue 2">
                    <iconify-icon icon="emojione:flag-for-france" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.ligue2">Ligue 2</span>
                </div>
                <div class="custom-select-option" data-value="Non Top 7 Leagues">
                    <iconify-icon icon="emojione:globe-showing-europe-africa" width="18" height="18"></iconify-icon>
                   <span data-i18n="leagues.outsidetop7">Outside Top 7</span>
                </div>
                <div class="custom-select-option" data-value="South America">
                    <iconify-icon icon="emojione:globe-showing-americas" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.southamerica">South America</span>
                </div>
                <div class="custom-select-option" data-value="Scandinavia">
                    <iconify-icon icon="emojione:globe-showing-europe-africa" width="18" height="18"></iconify-icon>
                 <span data-i18n="leagues.scandinavia">Scandinavia</span>
                </div>
                <div class="custom-select-option" data-value="Balkans">
                    <iconify-icon icon="emojione:globe-showing-europe-africa" width="18" height="18"></iconify-icon>
                    <span data-i18n="leagues.easterneurope">Eastern Europe</span>
                </div>  
            </div>
            
          </div>

          <!-- Replace input fields with range sliders -->
          <div class="range-field">
            <label for="defensiveActionsLow" data-i18n="metrics.gk.def_actions">Defensive Actions</label>
            <div class="range-slider-container">
              <input type="range" id="defensiveActionsLow" min="0" max="100" value="0" class="range-slider">
              <input type="number" class="range-value" id="defensiveActionsLowValue" value="0" min="0" max="100">
            </div>
          </div>

          <div class="range-field">
            <label for="aerialsContestedLow" data-i18n="metrics.gk.aerials">Aerials Contested</label>
            <div class="range-slider-container">
              <input type="range" id="aerialsContestedLow" min="0" max="100" value="0" class="range-slider">
              <input type="number" class="range-value" id="aerialsContestedLowValue" value="0" min="0" max="100">
            </div>
          </div>

          <div class="range-field">
            <label for="exitLineLow" data-i18n="metrics.gk.exit_line">Exit Line</label>
            <div class="range-slider-container">
              <input type="range" id="exitLineLow" min="0" max="100" value="0" class="range-slider">
              <input type="number" class="range-value" id="exitLineLowValue" value="0" min="0" max="100">
            </div>
          </div>

          <div class="range-field">
            <label for="passesLow" data-i18n="metrics.gk.passes">Passes</label>
            <div class="range-slider-container">
              <input type="range" id="passesLow" min="0" max="100" value="0" class="range-slider">
              <input type="number" class="range-value" id="passesLowValue" value="0" min="0" max="100">
            </div>
          </div>

          <div class="range-field">
            <label for="longPassPercentageLow" data-i18n="metrics.gk.long_pass">Long Pass %</label>
            <div class="range-slider-container">
              <input type="range" id="longPassPercentageLow" min="0" max="100" value="0" class="range-slider">
              <input type="number" class="range-value" id="longPassPercentageLowValue" value="0" min="0" max="100">
            </div>
          </div>

          <div class="range-field">
            <label for="shortPassPercentageLow" data-i18n="metrics.gk.short_pass">Short Pass %</label>
            <div class="range-slider-container">
              <input type="range" id="shortPassPercentageLow" min="0" max="100" value="0" class="range-slider">
              <input type="number" class="range-value" id="shortPassPercentageLowValue" value="0" min="0" max="100">
            </div>
          </div>

          <div class="range-field">
            <label for="psxgLow" data-i18n="metrics.gk.psxg_ga">PSxG - GA</label>
            <div class="range-slider-container">
              <input type="range" id="psxgLow" min="0" max="100" value="0" class="range-slider">
              <input type="number" class="range-value" id="psxgLowValue" value="0" min="0" max="100">
            </div>
          </div>

          <!-- Age range inputs -->
          <div class="input-group">
            <label for="ageLow" data-i18n="search.age">Age</label>
            <div class="input-row">
              <input type="number" id="ageLow" min="0" placeholder="15">
              <input type="number" id="ageHigh" min="0" placeholder="45">
            </div>
          </div>

          <!-- Minutes played range inputs -->
          <div class="input-group">
            <label for="minutesPlayedLow" data-i18n="search.minutes">Minutes Played</label>
            <div class="input-row">
              <input type="number" id="minutesPlayedLow" min="0" placeholder="0">
              <input type="number" id="minutesPlayedHigh" min="0" placeholder="10,000">
            </div>
          </div>

          <button type="submit" data-i18n="search.button">Search</button>
        </form>
      </div>
      
      <div class="inputs-toggle">
        <div class="inputs-toggle-icon"></div>
      </div>
    </div>

    <div id="tableWrapper">
      <div id="resultsContainer">
        <!-- The search results will be displayed here -->
      </div>
    </div>
  </div>
  <div class="top-controls">
    <div class="season-selector">
      <a class="active" style="user-select: none;">
        <span data-i18n="current">Current</span>
      </a>
      <div class="season-divider"></div>
      <a href="https://datamb.football/prosearch/" target="_self" rel="noopener noreferrer">
        <span data-i18n="previous">Previous</span>
      </a>
    </div>
  </div>

  <!-- Dark mode toggle placed fixed at bottom right just like in plot.html -->
  <div class="dark-mode-toggle" onclick="toggleDarkMode()">
    <span class="toggle-icon"></span>
  </div>

  <script src="main.js"></script>
  <script>
    // Function to toggle dark mode
    function toggleDarkMode() {
      const body = document.querySelector("body");
      body.classList.toggle("dark-mode");

      // Store the user's preference in local storage
      const isDarkMode = body.classList.contains("dark-mode");
      localStorage.setItem("darkMode", isDarkMode);
    }

    // Check if user has a stored preference for dark mode
    const storedDarkMode = localStorage.getItem("darkMode");

    if (storedDarkMode === "true") {
      const body = document.querySelector("body");
      body.classList.add("dark-mode");
    }

    // Setup for custom selectors
    function setupCustomSelect(trigger, options, selectElement) {
      // Toggle dropdown when clicking the trigger
      trigger.addEventListener('click', function() {
        // Close all other open dropdowns first
        document.querySelectorAll('.custom-select-trigger.open').forEach(function(openTrigger) {
          if (openTrigger !== trigger) {
            openTrigger.classList.remove('open');
            const openOptions = openTrigger.nextElementSibling;
            if (openOptions) openOptions.style.display = 'none';
          }
        });
        
        // Toggle this dropdown
        trigger.classList.toggle('open');
        const isOpen = trigger.classList.contains('open');
        options.style.display = isOpen ? 'block' : 'none';
      });
      
      // Handle option selection
      options.addEventListener('click', function(e) {
        const option = e.target.closest('.custom-select-option');
        if (!option) return;
        
        // Update selected option
        options.querySelectorAll('.custom-select-option').forEach(opt => 
          opt.classList.remove('selected')
        );
        option.classList.add('selected');
        
        // Update trigger text
        const dataValue = option.getAttribute('data-value');
        trigger.querySelector('span').textContent = option.textContent.trim();
        
        // Check if this is the league selector by looking for iconify-icon
        if (option.querySelector('iconify-icon')) {
          // Clone the icon from the option to the trigger
          const iconElement = option.querySelector('iconify-icon');
          const triggerIcon = trigger.querySelector('iconify-icon');
          
          // If trigger already has an icon, update it
          if (triggerIcon) {
            triggerIcon.setAttribute('icon', iconElement.getAttribute('icon'));
          } else {
            // Otherwise clone the icon and insert it before the span
            const newIcon = iconElement.cloneNode(true);
            trigger.insertBefore(newIcon, trigger.querySelector('span'));
          }
          
          // For special case with Scotland flag which uses a div instead of iconify-icon
          const scotlandFlag = option.querySelector('div[style*="twemoji"]');
          if (scotlandFlag) {
            // Remove any existing flag div in the trigger
            const existingFlag = trigger.querySelector('div[style*="twemoji"]');
            if (existingFlag) {
              existingFlag.remove();
            }
            // Clone and add the Scotland flag div
            const newFlag = scotlandFlag.cloneNode(true);
            trigger.insertBefore(newFlag, trigger.querySelector('span'));
            
            // Remove iconify-icon if it exists
            const iconToRemove = trigger.querySelector('iconify-icon');
            if (iconToRemove) {
              iconToRemove.remove();
            }
          } else if (scotlandFlag === null && trigger.querySelector('div[style*="twemoji"]')) {
            // Remove Scotland flag if present but current option is not Scotland
            trigger.querySelector('div[style*="twemoji"]').remove();
          }
        }
        
        // Update hidden select
        selectElement.value = dataValue;
        const event = new Event('change');
        selectElement.dispatchEvent(event);
        
        // Close dropdown
        trigger.classList.remove('open');
        options.style.display = 'none';
      });
    }

    // Function to handle inputs toggle on mobile
    function setupInputsToggle() {
      const inputsToggle = document.querySelector('.inputs-toggle');
      const inputs = document.querySelector('.inputs');
      
      // Default state for mobile - inputs visible by default
      if (window.innerWidth <= 1350) {
        // Don't add collapsed class by default
        // inputs.classList.add('collapsed');
        // inputsToggle.classList.add('collapsed');
      }
      
      inputsToggle.addEventListener('click', function() {
        inputs.classList.toggle('collapsed');
        this.classList.toggle('collapsed');
      });
      
      // Re-evaluate state on window resize
      window.addEventListener('resize', function() {
        if (window.innerWidth <= 1350) {
          // Only manage visibility, don't force collapsed state
        } else {
          // Remove collapsed classes on desktop
          inputs.classList.remove('collapsed');
          inputsToggle.classList.remove('collapsed');
        }
      });
    }

    // Custom function to update metric labels based on position
    function customUpdateMetricLabels(dataset) {
      let position = '';
      let metricLabels = [];
      
      // Maps for each position's metrics with proper attribute names
      const fieldMappingByPosition = {
        'gk': {
          'defensiveActionsLow': { label: 'Defensive Actions', key: 'metrics.gk.def_actions' },
          'aerialsContestedLow': { label: 'Aerials Contested', key: 'metrics.gk.aerials' },
          'exitLineLow': { label: 'Exit Line', key: 'metrics.gk.exit_line' },
          'passesLow': { label: 'Passes', key: 'metrics.gk.passes' },
          'longPassPercentageLow': { label: 'Long Pass %', key: 'metrics.gk.long_pass' },
          'shortPassPercentageLow': { label: 'Short Pass %', key: 'metrics.gk.short_pass' },
          'psxgLow': { label: 'PSxG - GA', key: 'metrics.gk.psxg_ga' }
        },
        'cb': {
          'defensiveActionsLow': { label: 'Passes', key: 'metrics.cb.passes' },
          'aerialsContestedLow': { label: 'Forward Pass %', key: 'metrics.cb.forward_pass' },
          'exitLineLow': { label: 'Progressive Passes', key: 'metrics.cb.prog_passes' },
          'passesLow': { label: 'Defensive Actions', key: 'metrics.cb.def_actions' },
          'longPassPercentageLow': { label: 'Defensive Duels', key: 'metrics.cb.def_duel' },
          'shortPassPercentageLow': { label: 'Aerial Duels', key: 'metrics.cb.aerial' },
          'psxgLow': { label: 'Progressive Carries', key: 'metrics.cb.prog_carries' }
        },
        'fb': {
          'defensiveActionsLow': { label: 'Crosses', key: 'metrics.fb.cross' },
          'aerialsContestedLow': { label: 'xA', key: 'metrics.fb.xa' },
          'exitLineLow': { label: 'Progressive Passes', key: 'metrics.fb.prog_passes' },
          'passesLow': { label: 'Defensive Actions', key: 'metrics.fb.def_actions' },
          'longPassPercentageLow': { label: 'Defensive Duels', key: 'metrics.fb.def_duel' },
          'shortPassPercentageLow': { label: 'Aerial Duels', key: 'metrics.fb.aerial' },
          'psxgLow': { label: 'Progressive Carries', key: 'metrics.fb.prog_carries' }
        },
        'cm': {
          'defensiveActionsLow': { label: 'Duels', key: 'metrics.cm.duel' },
          'aerialsContestedLow': { label: 'Defensive Actions', key: 'metrics.cm.def_actions' },
          'exitLineLow': { label: 'Progressive Carries', key: 'metrics.cm.prog_carries' },
          'passesLow': { label: 'Forward Passes', key: 'metrics.cm.forward_passes' },
          'longPassPercentageLow': { label: 'Forward Pass %', key: 'metrics.cm.forward_pass' },
          'shortPassPercentageLow': { label: 'Key Passes', key: 'metrics.cm.key_passes' },
          'psxgLow': { label: 'Progressive Passes', key: 'metrics.cm.prog_passes' }
        },
        'fw': {
          'defensiveActionsLow': { label: 'Progressive Carries', key: 'metrics.fw.prog_carries' },
          'aerialsContestedLow': { label: 'Dribbles', key: 'metrics.fw.dribbles' },
          'exitLineLow': { label: 'NPG', key: 'metrics.fw.npg' },
          'passesLow': { label: 'xG + xA', key: 'metrics.fw.xg_xa' },
          'longPassPercentageLow': { label: 'Assists', key: 'metrics.fw.assists' },
          'shortPassPercentageLow': { label: 'Key Passes', key: 'metrics.fw.key_passes' },
          'psxgLow': { label: 'Offensive Actions', key: 'metrics.fw.off_actions' }
        },
        'st': {
          'defensiveActionsLow': { label: 'Pass Received', key: 'metrics.st.pass_received' },
          'aerialsContestedLow': { label: 'Aerial Duels', key: 'metrics.st.aerial' },
          'exitLineLow': { label: 'NPG', key: 'metrics.st.npg' },
          'passesLow': { label: 'xG', key: 'metrics.st.xg' },
          'longPassPercentageLow': { label: 'Pass to Pen', key: 'metrics.st.pass_to_pen' },
          'shortPassPercentageLow': { label: 'xA', key: 'metrics.st.xa' },
          'psxgLow': { label: 'Offensive Actions', key: 'metrics.st.off_actions' }
        }
      };
      
      // Determine position code based on dataset
      switch(dataset) {
        case 'dataset1': position = 'gk'; break;
        case 'dataset2': position = 'cb'; break;
        case 'dataset3': position = 'fb'; break;
        case 'dataset4': position = 'cm'; break;
        case 'dataset5': position = 'fw'; break;
        case 'dataset6': position = 'st'; break;
      }
      
      const mappingForPosition = fieldMappingByPosition[position];
      
      // Update each label with the metric name for this position
      Object.entries(mappingForPosition).forEach(([fieldId, metadata]) => {
        const label = document.querySelector(`label[for="${fieldId}"]`);
        if (label) {
          // Set the data-i18n attribute for translations
          label.setAttribute('data-i18n', metadata.key);
          
          // Set the actual metric name directly
          label.textContent = metadata.label;
        }
      });
    }

    // Initialize custom selectors
    document.addEventListener('DOMContentLoaded', function() {
      // Position selector
      const positionSelector = document.getElementById('datasetSelector');
      const positionTrigger = document.getElementById('position-select-trigger');
      const positionOptions = document.getElementById('position-select-options');
      
      // Populate position options
      Array.from(positionSelector.options).forEach(option => {
        const customOption = document.createElement('div');
        customOption.className = 'custom-select-option';
        if (option.selected) customOption.classList.add('selected');
        customOption.setAttribute('data-value', option.value);
        customOption.textContent = option.textContent;
        positionOptions.appendChild(customOption);
      });
      
      setupCustomSelect(positionTrigger, positionOptions, positionSelector);
      
      // League selector
      const leagueSelector = document.getElementById('league');
      const leagueTrigger = document.getElementById('league-select-trigger');
      const leagueOptions = document.getElementById('league-select-options');
      

      
      setupCustomSelect(leagueTrigger, leagueOptions, leagueSelector);

      // Range sliders - critical fix for search functionality
      document.querySelectorAll('.range-slider').forEach(slider => {
        const valueInput = slider.nextElementSibling;
        
        // Set initial position as a CSS variable
        const percent = (slider.value - slider.min) / (slider.max - slider.min) * 100;
        slider.style.setProperty('--slider-position', `${percent}%`);
        
        // Update value input and position on slider input
        slider.addEventListener('input', function() {
          // Update value input
          valueInput.value = this.value;
          
          // Update the original slider's value to ensure JS can find it
          this.value = valueInput.value;
          
          // Update position CSS variable
          const percent = (this.value - this.min) / (this.max - this.min) * 100;
          this.style.setProperty('--slider-position', `${percent}%`);
        });
        
        // Update slider when value input changes
        valueInput.addEventListener('input', function() {
          // Make sure the value is within bounds
          let value = parseInt(this.value);
          
          // Handle empty input
          if (isNaN(value)) {
            value = 0;
          }
          
          // Clamp value between min and max
          value = Math.max(0, Math.min(100, value));
          
          // Update value if it was adjusted
          this.value = value;
          
          // Update slider value
          slider.value = value;
          
          // Update position CSS variable
          const percent = (value - slider.min) / (slider.max - slider.min) * 100;
          slider.style.setProperty('--slider-position', `${percent}%`);
        });
      });

      // Fix for preserving slider values when changing position or league
      // Override datasetSelector change event
      positionSelector.addEventListener('change', function() {
        // Call our custom function to update labels based on position
        customUpdateMetricLabels(this.value);
        
        // The original event in main.js will run and clear all inputs, then we'll restore our values
        setTimeout(() => {
          // After main.js has run clearSearchInputs(), reset sliders to 0
          document.querySelectorAll('.range-slider').forEach(slider => {
            // Reset to 0 for all sliders when changing position
            slider.value = 0;
            const valueInput = slider.nextElementSibling;
            valueInput.value = 0;
            
            // Reset position variable
            slider.style.setProperty('--slider-position', '0%');
          });
        }, 10); // Small delay to ensure this runs after main.js event handler
      }, true); // Use capture phase to run before main.js handler
      
      // Same for league changes
      leagueSelector.addEventListener('change', function() {
        // Run this after the original event handler to restore values
        setTimeout(() => {
          // Make sure slider values are correctly set
          document.querySelectorAll('.range-slider').forEach(slider => {
            // For league changes, ensure values are correctly synchronized
            if (!slider.value) {
              slider.value = 0;
            }
            const valueInput = slider.nextElementSibling;
            if (!valueInput.value) {
              valueInput.value = 0;
            }
            
            // Update position variable
            const percent = (slider.value - slider.min) / (slider.max - slider.min) * 100;
            slider.style.setProperty('--slider-position', `${percent}%`);
          });
        }, 10); // Small delay to ensure this runs after main.js event handler
      });

      // Override form submission to ensure slider values are properly set
      document.getElementById('searchForm').addEventListener('submit', function(event) {
        // Don't preventDefault here - let the main.js handle it
        
        // Make sure range slider values are synchronized before submission
        document.querySelectorAll('.range-slider').forEach(slider => {
          const valueInput = slider.nextElementSibling;
          slider.value = valueInput.value || 0;
        });
        
        // Clear the tableWrapper to ensure we don't have stale results
        const tableWrapper = document.getElementById('tableWrapper');
        tableWrapper.innerHTML = '<div id="resultsContainer"></div>';
      }, true); // Use capture phase to run before main.js handler

      // Click outside to close dropdowns
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.custom-select-container')) {
          document.querySelectorAll('.custom-select-trigger.open').forEach(trigger => {
            trigger.classList.remove('open');
            trigger.nextElementSibling.style.display = 'none';
          });
        }
      });
      
      // Initialize the labels on page load
      customUpdateMetricLabels('dataset1');
    });

    let translations = {};
    let currentLanguage = 'en';

    function getPreferredLanguage() {
      // PRIORITY 1: URL parameter
      const urlParams = new URLSearchParams(window.location.search);
      const langParam = urlParams.get('lang');
      
      if (langParam) {
        return langParam; 
      }
      
      // PRIORITY 2: Stored preference
      const storedLang = localStorage.getItem('preferredLanguage');
      if (storedLang) {
        return storedLang;
      }
      
      // PRIORITY 3: Browser language
      const browserLang = navigator.language.slice(0, 2);
      return browserLang || 'en';
    }

    // Helper function to get nested translations
    function getNestedTranslation(obj, path) {
      return path.split('.').reduce((acc, part) => acc && acc[part], obj);
    }

    // Load and apply translations
    async function applyLanguage(lang) {
      currentLanguage = lang;
      console.log(lang);

      // Skip fetching translations for English
      if (lang === 'en') {
        return;
      }
      
      try {
        const response = await fetch(`./locales/${lang}.json`);
        
        // Don't throw an error, just return null if response is not OK
        if (response.ok) {
          translations = await response.json();
        } else {
          translations = null;
        }
      } catch (error) {
        translations = null;
      }
      
      // Apply translations to all elements with data-i18n attribute
      document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        const translation = getNestedTranslation(translations, key);
        if (translation) {
          if (translation.includes('<')) {
            element.innerHTML = translation;
          } else {
            element.textContent = translation;
          }
        }
      });

      // Update position selector options
      const datasetSelector = document.getElementById('datasetSelector');
      if (datasetSelector) {
        const defaultPositions = {
          'goalkeepers': 'Goalkeepers',
          'centre-backs': 'Centre-backs',
          'full-backs': 'Full-backs',
          'midfielders': 'Midfielders',
          'wingers': 'Wingers',
          'strikers': 'Strikers'
        };
        
        const positions = translations && translations.position ? translations.position : defaultPositions;
        
        datasetSelector.options[0].textContent = positions.goalkeepers || defaultPositions.goalkeepers;
        datasetSelector.options[1].textContent = positions['centre-backs'] || defaultPositions['centre-backs'];
        datasetSelector.options[2].textContent = positions['full-backs'] || defaultPositions['full-backs'];
        datasetSelector.options[3].textContent = positions.midfielders || defaultPositions.midfielders;
        datasetSelector.options[4].textContent = positions.wingers || defaultPositions.wingers;
        datasetSelector.options[5].textContent = positions.strikers || defaultPositions.strikers;
        
        // Update custom selector text
        const positionTrigger = document.getElementById('position-select-trigger');
        const selectedOption = datasetSelector.options[datasetSelector.selectedIndex];
        if (positionTrigger && selectedOption) {
          positionTrigger.querySelector('span').textContent = selectedOption.textContent;
        }
      }
    }

    // Initialize with preferred language following priority rules
    document.addEventListener('DOMContentLoaded', async () => {
      const preferredLanguage = getPreferredLanguage();
      await applyLanguage(preferredLanguage);
      
      // Setup inputs toggle for mobile
      setupInputsToggle();
    });
  </script>
</body>
</html>
